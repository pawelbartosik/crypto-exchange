<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    <changeSet id="20250115-pawel-001" author="pawel">
        <sql>
            create table account
            (
                id      integer generated by default as identity
                    primary key,
                pesel   varchar(11) unique    not null,
                name    varchar(255)          not null,
                surname varchar(255)          not null,
                version bigint default 0      not null
            );
        </sql>
    </changeSet>
    <changeSet id="20250115-pawel-002" author="pawel">
        <sql>
            create table sub_account
            (
                id       integer generated by default as identity
                    primary key,
                pesel    varchar(11)    not null,
                currency varchar(3)     not null,
                amount   decimal(38, 18) not null,
                version bigint default 0      not null,
                FOREIGN KEY (pesel) REFERENCES account (pesel)
            );
        </sql>
    </changeSet>
<!--    <changeSet id="20250115-pawel-003" author="pawel">-->
<!--        <sql>-->
<!--            CREATE VIEW account_view AS-->
<!--            SELECT-->
<!--            a.id AS id,-->
<!--            a.pesel AS pesel,-->
<!--            a.name AS name,-->
<!--            a.surname AS surname,-->
<!--            sa.currency AS currency,-->
<!--            sa.amount AS amount-->
<!--            FROM-->
<!--            account a-->
<!--            LEFT JOIN-->
<!--            sub_account sa-->
<!--            ON-->
<!--            a.pesel = sa.pesel;-->
<!--        </sql>-->
<!--    </changeSet>-->
    <changeSet id="20250115-pawel-003" author="pawel">
        <sql>
            CREATE VIEW account_view AS
            SELECT
            a.id AS id,
            a.pesel AS pesel,
            a.name AS name,
            a.surname AS surname,
            GROUP_CONCAT(sa.currency || ': ' || sa.amount SEPARATOR '; ') AS sub_accounts
            FROM
            account a
            LEFT JOIN
            sub_account sa
            ON
            a.pesel = sa.pesel
            GROUP BY
            a.id, a.pesel, a.name, a.surname;
        </sql>
    </changeSet>
<!--    chciaÅ‚em JSON_ARRAYAGG ale h2 tego nie wspiera-->
</databaseChangeLog>